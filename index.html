<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PowerCalc Pro - Electric Bill Calculator</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Professional electric bill calculator with offline functionality for Bangladesh">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="PowerCalc Pro">
    <meta name="msapplication-TileColor" content="#667eea">
    
    <!-- Favicon with your logo -->
    <link rel="icon" type="image/png" href="https://i.ibb.co.com/4RwDKSd1/A-removebg-preview.png">
    <link rel="apple-touch-icon" href="https://i.ibb.co.com/4RwDKSd1/A-removebg-preview.png">
    <link rel="shortcut icon" href="https://i.ibb.co.com/4RwDKSd1/A-removebg-preview.png">
    
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --accent-color: #f093fb;
            --success-color: #4ade80;
            --warning-color: #fbbf24;
            --error-color: #ef4444;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --text-light: #ffffff;
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --border-color: #e5e7eb;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            --border-radius: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: var(--text-primary);
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 50%, var(--accent-color) 100%);
            min-height: 100vh;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }

        /* Bengali font support */
        .bengali {
            font-family: 'Noto Sans Bengali', 'Kalpurush', 'SolaimanLipi', Arial, sans-serif;
        }

        /* Animated background elements */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.3) 0%, transparent 50%);
            animation: float 20s ease-in-out infinite;
            z-index: -1;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            33% { transform: translateY(-20px) rotate(1deg); }
            66% { transform: translateY(10px) rotate(-1deg); }
        }

        /* Language Toggle */
        .language-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            display: flex;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 25px;
            padding: 5px;
            box-shadow: var(--shadow-md);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .lang-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: var(--transition);
            color: var(--text-secondary);
        }

        .lang-btn.active {
            background: var(--primary-color);
            color: white;
            box-shadow: var(--shadow-sm);
        }

        .lang-btn:hover:not(.active) {
            background: rgba(102, 126, 234, 0.1);
            color: var(--primary-color);
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 50%, var(--accent-color) 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out, visibility 0.5s ease-out;
        }

        .loading-screen.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .loading-logo {
            width: 120px;
            height: 120px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-xl);
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
            animation: pulse 2s ease-in-out infinite;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .loading-logo img {
            width: 80px;
            height: 80px;
            object-fit: contain;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
        }

        .loading-logo::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
            transform: rotate(45deg);
            animation: shine 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes shine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            50% { transform: translateX(100%) translateY(100%) rotate(45deg); }
            100% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
        }

        .loading-text {
            color: var(--text-light);
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .loading-subtitle {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1rem;
            margin-bottom: 2rem;
            text-align: center;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--text-light);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* User Authentication Screen */
        .auth-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 50%, var(--accent-color) 100%);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9998;
            padding: 20px;
            overflow-y: auto; /* Allow scrolling for smaller screens */
        }

        .auth-screen.show {
            display: flex;
        }

        .auth-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--border-radius);
            padding: 2rem;
            box-shadow: var(--shadow-xl);
            max-width: 500px;
            width: 100%;
            text-align: center;
            animation: slideUp 0.8s ease-out;
            margin: 20px 0; /* Add margin for scrolling */
        }

        .auth-logo {
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-lg);
            margin-bottom: 1.5rem;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(102, 126, 234, 0.2);
        }

        .auth-logo img {
            width: 50px;
            height: 50px;
            object-fit: contain;
        }

        .auth-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .auth-subtitle {
            color: var(--text-secondary);
            margin-bottom: 2rem;
            font-size: 1.1rem;
        }

        .auth-form {
            text-align: left;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 1rem;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
            background: var(--bg-primary);
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .auth-btn {
            width: 100%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: var(--text-light);
            padding: 1rem 2rem;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            margin-top: 1rem;
        }

        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .social-auth-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 0.8rem 1.5rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            margin-bottom: 1rem;
        }

        .social-auth-btn:hover {
            background-color: var(--bg-secondary);
            border-color: var(--primary-color);
        }

        .social-auth-btn img {
            width: 24px;
            height: 24px;
            margin-right: 10px;
        }

        .or-divider {
            display: flex;
            align-items: center;
            text-align: center;
            margin: 1.5rem 0;
            color: var(--text-secondary);
        }

        .or-divider::before,
        .or-divider::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid var(--border-color);
        }

        .or-divider:not(:empty)::before {
            margin-right: .5em;
        }

        .or-divider:not(:empty)::after {
            margin-left: .5em;
        }

        .auth-error {
            color: var(--error-color);
            font-size: 0.9rem;
            margin-top: 1rem;
            text-align: center;
        }

        #recaptcha-container {
            margin-top: 1.5rem;
            display: flex;
            justify-content: center;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
            display: none;
        }

        .container.show {
            display: block;
            animation: fadeIn 0.8s ease-out;
        }

        /* Welcome Header */
        .welcome-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-md);
            text-align: center;
            animation: slideDown 0.8s ease-out;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .welcome-message {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .user-info {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .sign-out-btn {
            background: var(--error-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .sign-out-btn:hover {
            background: #dc2626;
        }

        /* PWA Install Banner */
        .install-banner {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--border-radius);
            padding: 1rem;
            margin-bottom: 1rem;
            display: none;
            align-items: center;
            gap: 1rem;
            box-shadow: var(--shadow-md);
            animation: slideDown 0.5s ease-out;
        }

        .install-banner.show {
            display: flex;
        }

        .install-icon {
            font-size: 2rem;
        }

        .install-content {
            flex: 1;
        }

        .install-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .install-description {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .install-btn {
            background: var(--primary-color);
            color: var(--text-light);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .install-btn:hover {
            background: var(--secondary-color);
        }

        .close-banner {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0.25rem;
        }

        /* Connection Status */
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            z-index: 1000;
            transition: var(--transition);
            display: none;
        }

        .connection-status.online {
            background: var(--success-color);
            color: white;
        }

        .connection-status.offline {
            background: var(--error-color);
            color: white;
            display: block;
        }

        .logo-section {
            text-align: center;
            margin-bottom: 2rem;
            animation: slideDown 0.8s ease-out;
        }

        .logo {
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-lg);
            margin-bottom: 1rem;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .logo img {
            width: 50px;
            height: 50px;
            object-fit: contain;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }

        .logo::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
            transform: rotate(45deg);
            animation: shine 3s infinite;
        }

        .company-name {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-light);
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .pwa-badge {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            color: var(--text-light);
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-top: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .calculator {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--border-radius);
            padding: 2.5rem;
            box-shadow: var(--shadow-xl);
            position: relative;
            overflow: hidden;
            animation: slideUp 0.8s ease-out 0.2s both;
        }

        .calculator::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
        }

        .date-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .calculator h2 {
            font-size: 2rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 2rem;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .input-group {
            margin-bottom: 1.5rem;
            position: relative;
        }

        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .input-wrapper {
            position: relative;
        }

        .input-wrapper::before {
            content: '⚡';
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary-color);
            font-size: 1.2rem;
            z-index: 1;
        }

        input, select {
            width: 100%;
            padding: 1rem 1rem 1rem 2.5rem;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        select {
            padding-left: 1rem;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }

        input:hover, select:hover {
            border-color: var(--primary-color);
        }

        .calculate-btn {
            width: 100%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: var(--text-light);
            padding: 1rem 2rem;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            margin: 1.5rem 0;
        }

        .calculate-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: var(--transition);
        }

        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .calculate-btn:hover::before {
            left: 100%;
        }

        .calculate-btn:active {
            transform: translateY(0);
        }

        .result {
            margin-top: 2rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(240, 147, 251, 0.1));
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: var(--border-radius);
            display: none;
            animation: fadeInUp 0.5s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .result h3 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .result h3::before {
            content: '📊';
            font-size: 1.2rem;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid rgba(102, 126, 234, 0.1);
            font-size: 1rem;
        }

        .result-item:last-child {
            border-bottom: none;
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--success-color);
        }

        .result-label {
            color: var(--text-secondary);
        }

        .result-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        .month-info {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: var(--border-radius);
            padding: 1rem;
            margin-bottom: 1rem;
            text-align: center;
            font-weight: 600;
            color: var(--primary-color);
        }

        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: var(--error-color);
            padding: 1rem;
            border-radius: var(--border-radius);
            margin: 1rem 0;
            display: none;
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* History Section */
        .history-section {
            margin-top: 2rem;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow-md);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .history-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .clear-history {
            background: var(--error-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .clear-history:hover {
            background: #dc2626;
        }

        .history-item {
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            background: var(--bg-primary);
        }

        .history-date {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .history-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 0 1rem;
            }
            
            .calculator {
                padding: 1.5rem;
            }
            
            .calculator h2 {
                font-size: 1.5rem;
            }
            
            .logo {
                width: 60px;
                height: 60px;
            }

            .logo img {
                width: 35px;
                height: 35px;
            }
            
            .company-name {
                font-size: 1.2rem;
            }

            .install-banner {
                flex-direction: column;
                text-align: center;
            }

            .connection-status {
                top: 70px;
                right: 10px;
                font-size: 0.7rem;
            }

            .auth-card {
                padding: 2rem;
                margin: 1rem;
            }

            .loading-logo {
                width: 100px;
                height: 100px;
            }

            .loading-logo img {
                width: 60px;
                height: 60px;
            }

            .language-toggle {
                top: 10px;
                left: 10px;
                font-size: 0.8rem;
            }

            .lang-btn {
                padding: 6px 12px;
                font-size: 0.8rem;
            }

            .date-row {
                grid-template-columns: 1fr;
                gap: 0;
            }
        }

        /* Loading animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        /* Utility classes */
        .hidden {
            display: none !important;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- Language Toggle -->
    <div class="language-toggle">
        <button class="lang-btn active" data-lang="en">English</button>
        <button class="lang-btn" data-lang="bn">বাংলা</button>
    </div>

    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-logo">
            <img src="https://i.ibb.co.com/4RwDKSd1/A-removebg-preview.png" alt="PowerCalc Pro Logo" crossorigin="anonymous">
        </div>
        <div class="loading-text" data-en="PowerCalc Pro" data-bn="পাওয়ারক্যালক প্রো">PowerCalc Pro</div>
        <div class="loading-subtitle" data-en="Electric Bill Calculator for Bangladesh<br>Loading your personalized experience..." data-bn="বাংলাদেশের জন্য বিদ্যুৎ বিল ক্যালকুলেটর<br>আপনার ব্যক্তিগত অভিজ্ঞতা লোড হচ্ছে...">Electric Bill Calculator for Bangladesh<br>Loading your personalized experience...</div>
        <div class="loading-spinner"></div>
    </div>

    <!-- User Authentication Screen -->
    <div class="auth-screen" id="authScreen">
        <div class="auth-card">
            <div class="auth-logo">
                <img src="https://i.ibb.co.com/4RwDKSd1/A-removebg-preview.png" alt="PowerCalc Pro Logo" crossorigin="anonymous">
            </div>
            <h2 class="auth-title" data-en="Welcome to PowerCalc Pro" data-bn="পাওয়ারক্যালক প্রো-তে স্বাগতম">Welcome to PowerCalc Pro</h2>
            <p class="auth-subtitle" data-en="Sign in or create an account to get started!" data-bn="শুরু করতে সাইন ইন করুন অথবা একটি অ্যাকাউন্ট তৈরি করুন!">Sign in or create an account to get started!</p>
            
            <div class="auth-error" id="authError"></div>

            <!-- Google Sign-in -->
            <button class="social-auth-btn" id="googleSignInBtn">
                <img src="https://upload.wikimedia.org/wikipedia/commons/4/4a/Logo_of_Google_G_Suite.png" alt="Google logo">
                <span data-en="Sign in with Google" data-bn="গুগল দিয়ে সাইন ইন করুন">Sign in with Google</span>
            </button>

            <div class="or-divider" data-en="OR" data-bn="অথবা">OR</div>

            <!-- Email/Password Authentication -->
            <form class="auth-form" id="emailAuthForm">
                <div class="form-group">
                    <label for="authEmail" data-en="Email" data-bn="ইমেল">Email</label>
                    <input type="email" id="authEmail" data-en-placeholder="your@example.com" data-bn-placeholder="আপনার@উদাহরণ.কম" placeholder="your@example.com" required>
                </div>
                <div class="form-group">
                    <label for="authPassword" data-en="Password" data-bn="পাসওয়ার্ড">Password</label>
                    <input type="password" id="authPassword" data-en-placeholder="Enter your password" data-bn-placeholder="আপনার পাসওয়ার্ড লিখুন" placeholder="Enter your password" required>
                </div>
                <button type="submit" class="auth-btn" id="signInBtn">
                    <span id="signInBtnText" data-en="Sign In" data-bn="সাইন ইন করুন">Sign In</span>
                    <span id="signInBtnLoading" class="loading hidden"></span>
                </button>
                <button type="button" class="auth-btn" id="signUpBtn" style="background: var(--accent-color); margin-top: 0.5rem;">
                    <span id="signUpBtnText" data-en="Sign Up" data-bn="সাইন আপ করুন">Sign Up</span>
                    <span id="signUpBtnLoading" class="loading hidden"></span>
                </button>
            </form>

            <div class="or-divider" data-en="OR" data-bn="অথবা">OR</div>

            <!-- Phone Authentication -->
            <form class="auth-form" id="phoneAuthForm">
                <div class="form-group">
                    <label for="phoneNumber" data-en="Phone Number" data-bn="ফোন নম্বর">Phone Number</label>
                    <input type="tel" id="phoneNumber" data-en-placeholder="+8801XXXXXXXXX" data-bn-placeholder="+8801XXXXXXXXX" placeholder="+8801XXXXXXXXX" required>
                </div>
                <button type="button" class="auth-btn" id="sendOtpBtn">
                    <span id="sendOtpBtnText" data-en="Send OTP" data-bn="ওটিপি পাঠান">Send OTP</span>
                    <span id="sendOtpBtnLoading" class="loading hidden"></span>
                </button>
                <div class="form-group hidden" id="otpInputGroup">
                    <label for="otpCode" data-en="Verification Code (OTP)" data-bn="যাচাইকরণ কোড (ওটিপি)">Verification Code (OTP)</label>
                    <input type="text" id="otpCode" data-en-placeholder="Enter OTP" data-bn-placeholder="ওটিপি লিখুন" required>
                </div>
                <button type="button" class="auth-btn hidden" id="verifyOtpBtn" style="background: var(--success-color);">
                    <span id="verifyOtpBtnText" data-en="Verify OTP" data-bn="ওটিপি যাচাই করুন">Verify OTP</span>
                    <span id="verifyOtpBtnLoading" class="loading hidden"></span>
                </button>
                <div id="recaptcha-container"></div>
            </form>

            <!-- Name input for new users (if not provided by auth provider) -->
            <form class="auth-form hidden" id="nameRegistrationForm">
                <div class="form-group">
                    <label for="userName" data-en="Your Name" data-bn="আপনার নাম">Your Name</label>
                    <input type="text" id="userName" data-en-placeholder="Enter your full name" data-bn-placeholder="আপনার পূর্ণ নাম লিখুন" placeholder="Enter your full name" required>
                </div>
                <button type="submit" class="auth-btn">
                    <span id="completeRegistrationBtnText" data-en="Continue to Calculator" data-bn="ক্যালকুলেটরে যান">Continue to Calculator</span>
                    <span id="completeRegistrationBtnLoading" class="loading hidden"></span>
                </button>
            </form>
        </div>
    </div>

    <!-- Connection Status -->
    <div class="connection-status" id="connectionStatus">
        📡 <span data-en="Offline Mode" data-bn="অফলাইন মোড">Offline Mode</span>
    </div>

    <div class="container" id="mainContainer">
        <!-- Welcome Header -->
        <div class="welcome-header" id="welcomeHeader">
            <div>
                <div class="welcome-message" id="welcomeMessage">Welcome back!</div>
                <div class="user-info" id="userInfo" data-en="Ready to calculate your electricity bill" data-bn="আপনার বিদ্যুৎ বিল গণনা করতে প্রস্তুত">Ready to calculate your electricity bill</div>
            </div>
            <button class="sign-out-btn" id="signOutBtn" data-en="Sign Out" data-bn="সাইন আউট">Sign Out</button>
        </div>

        <!-- PWA Install Banner -->
        <div class="install-banner" id="installBanner">
            <div class="install-icon">📱</div>
            <div class="install-content">
                <div class="install-title" data-en="Install PowerCalc Pro" data-bn="পাওয়ারক্যালক প্রো ইনস্টল করুন">Install PowerCalc Pro</div>
                <div class="install-description" data-en="Get quick access and use offline" data-bn="দ্রুত অ্যাক্সেস পান এবং অফলাইনে ব্যবহার করুন">Get quick access and use offline</div>
            </div>
            <button class="install-btn" id="installBtn" data-en="Install" data-bn="ইনস্টল">Install</button>
            <button class="close-banner" id="closeBanner">&times;</button>
        </div>

        <div class="logo-section">
            <div class="logo">
                <img src="https://i.ibb.co.com/4RwDKSd1/A-removebg-preview.png" alt="PowerCalc Pro Logo" crossorigin="anonymous">
            </div>
            <div class="company-name" data-en="PowerCalc Pro" data-bn="পাওয়ারক্যালক প্রো">PowerCalc Pro</div>
            <div class="pwa-badge" data-en="PWA Enabled • Bangladesh" data-bn="PWA সক্রিয় • বাংলাদেশ">PWA সক্রিয় • বাংলাদেশ</div>
        </div>

        <div class="calculator">
            <h2 data-en="Electric Bill Calculator" data-bn="বিদ্যুৎ বিল ক্যালকুলেটর">Electric Bill Calculator</h2>
            
            <div class="error-message" id="errorMessage">
                <strong data-en="Error:" data-bn="ত্রুটি:">Error:</strong> <span id="errorText"></span>
            </div>

            <form id="calculatorForm">
                <div class="date-row">
                    <div class="input-group">
                        <label for="billMonth" data-en="Select Month" data-bn="মাস নির্বাচন করুন">Select Month</label>
                        <select id="billMonth" required>
                            <option value="" data-en="Choose month" data-bn="মাস বেছে নিন">Choose month</option>
                            <option value="January" data-en="January" data-bn="জানুয়ারি">January</option>
                            <option value="February" data-en="February" data-bn="ফেব্রুয়ারি">February</option>
                            <option value="March" data-en="March" data-bn="মার্চ">March</option>
                            <option value="April" data-en="April" data-bn="এপ্রিল">April</option>
                            <option value="May" data-en="May" data-bn="মে">May</option>
                            <option value="June" data-en="June" data-bn="জুন">June</option>
                            <option value="July" data-en="July" data-bn="জুলাই">July</option>
                            <option value="August" data-en="August" data-bn="আগস্ট">August</option>
                            <option value="September" data-en="September" data-bn="সেপ্টেম্বর">September</option>
                            <option value="October" data-en="October" data-bn="অক্টোবর">October</option>
                            <option value="November" data-en="November" data-bn="নভেম্বর">November</option>
                            <option value="December" data-en="December" data-bn="ডিসেম্বর">December</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label for="billYear" data-en="Select Year" data-bn="বছর নির্বাচন করুন">Select Year</label>
                        <select id="billYear" required>
                            <option value="" data-en="Choose year" data-bn="বছর বেছে নিন">Choose year</option>
                        </select>
                    </div>
                </div>

                <div class="input-group">
                    <label for="presentKwh" data-en="Present KW/h Reading" data-bn="বর্তমান KW/h রিডিং">Present KW/h Reading</label>
                    <div class="input-wrapper">
                        <input type="number" id="presentKwh" data-en-placeholder="Enter current month's reading" data-bn-placeholder="বর্তমান মাসের রিডিং লিখুন" placeholder="Enter current month's reading" required step="0.01" min="0">
                    </div>
                </div>

                <div class="input-group">
                    <label for="pastKwh" data-en="Previous KW/h Reading" data-bn="পূর্ববর্তী KW/h রিডিং">Previous KW/h Reading</label>
                    <div class="input-wrapper">
                        <input type="number" id="pastKwh" data-en-placeholder="Enter last month's reading" data-bn-placeholder="গত মাসের রিডিং লিখুন" placeholder="Enter last month's reading" required step="0.01" min="0">
                    </div>
                </div>

                <button type="submit" class="calculate-btn" id="calculateBtn">
                    <span id="btnText" data-en="Calculate Bill" data-bn="বিল গণনা করুন">Calculate Bill</span>
                    <span id="btnLoading" class="loading hidden"></span>
                </button>
            </form>

            <div class="result" id="result">
                <div class="month-info" id="monthInfo"></div>
                <h3 data-en="Bill Summary" data-bn="বিল সারসংক্ষেপ">Bill Summary</h3>
                <div class="result-item">
                    <span class="result-label" data-en="Units Consumed:" data-bn="ব্যবহৃত ইউনিট:">Units Consumed:</span>
                    <span class="result-value"><span id="usedKwh"></span> KW/h</span>
                </div>
                <div class="result-item">
                    <span class="result-label" data-en="Energy Charge:" data-bn="শক্তি চার্জ:">Energy Charge:</span>
                    <span class="result-value">৳<span id="energyCharge"></span></span>
                </div>
                <div class="result-item">
                    <span class="result-label" data-en="Demand Charge:" data-bn="ডিমান্ড চার্জ:">Demand Charge:</span>
                    <span class="result-value">৳<span id="demandCharge"></span></span>
                </div>
                <div class="result-item">
                    <span class="result-label" data-en="Meter Fee:" data-bn="মিটার ফি:">Meter Fee:</span>
                    <span class="result-value">৳<span id="meterFee"></span></span>
                </div>
                <div class="result-item">
                    <span class="result-label" data-en="VAT (5%):" data-bn="ভ্যাট (৫%):">VAT (5%):</span>
                    <span class="result-value">৳<span id="vat"></span></span>
                </div>
                <div class="result-item">
                    <span class="result-label" data-en="Total Bill:" data-bn="মোট বিল:">Total Bill:</span>
                    <span class="result-value">৳<span id="totalBill"></span></span>
                </div>
            </div>
        </div>

        <!-- History Section -->
        <div class="history-section" id="historySection" style="display: none;">
            <div class="history-header">
                <h3 class="history-title" data-en="📋 Calculation History" data-bn="📋 গণনার ইতিহাস">📋 Calculation History</h3>
                <button class="clear-history" id="clearHistory" data-en="Clear All" data-bn="সব মুছুন">Clear All</button>
            </div>
            <div id="historyList"></div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, createUserWithEmailAndPassword, signInWithEmailAndPassword, RecaptchaVerifier, signInWithPhoneNumber, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCDrd2yXI34CITKBVoqAZANhKAb0OfCf8o",
            authDomain: "authentication-680af.firebaseapp.com",
            projectId: "authentication-680af",
            storageBucket: "authentication-680af.firebasestorage.app",
            messagingSenderId: "957976776655",
            appId: "1:957976776655:web:c069165c3265ad52b58cba",
            measurementId: "G-TL8P6K80NG"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);

        // Language system
        let currentLanguage = localStorage.getItem('powerCalcLanguage') || 'en';
        
        const translations = {
            en: {
                months: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
                welcomeBack: 'Welcome back',
                billFor: 'Bill for',
                online: 'Online',
                offline: 'Offline Mode',
                errors: {
                    selectMonth: 'Please select a month.',
                    selectYear: 'Please select a year.',
                    validNumbers: 'Please enter valid numbers for both readings.',
                    negativeValues: 'Readings cannot be negative values.',
                    currentLessThanPrevious: 'Present KW/h cannot be less than Past KW/h.',
                    enterName: 'Please enter your name.',
                    authFailed: 'Authentication failed. Please check your credentials or try again.',
                    emailInUse: 'Email already in use. Please sign in or use a different email.',
                    weakPassword: 'Password should be at least 6 characters.',
                    invalidEmail: 'Invalid email address.',
                    invalidPhoneNumber: 'Please enter a valid phone number (e.g., +8801XXXXXXXXX).',
                    otpSent: 'OTP sent to your phone. Please enter it below.',
                    otpFailed: 'Failed to send OTP. Please try again.',
                    invalidOtp: 'Invalid OTP. Please try again.',
                    tooManyRequests: 'Too many requests. Please try again later.'
                }
            },
            bn: {
                months: ['জানুয়ারি', 'ফেব্রুয়ারি', 'মার্চ', 'এপ্রিল', 'মে', 'জুন', 'জুলাই', 'আগস্ট', 'সেপ্টেম্বর', 'অক্টোবর', 'নভেম্বর', 'ডিসেম্বর'],
                welcomeBack: 'আবার স্বাগতম',
                billFor: 'বিল',
                online: 'অনলাইন',
                offline: 'অফলাইন মোড',
                errors: {
                    selectMonth: 'অনুগ্রহ করে একটি মাস নির্বাচন করুন।',
                    selectYear: 'অনুগ্রহ করে একটি বছর নির্বাচন করুন।',
                    validNumbers: 'অনুগ্রহ করে উভয় রিডিংয়ের জন্য বৈধ সংখ্যা লিখুন।',
                    negativeValues: 'রিডিং নেতিবাচক মান হতে পারে না।',
                    currentLessThanPrevious: 'বর্তমান KW/h পূর্ববর্তী KW/h এর চেয়ে কম হতে পারে না।',
                    enterName: 'অনুগ্রহ করে আপনার নাম লিখুন।',
                    authFailed: 'প্রমাণীকরণ ব্যর্থ হয়েছে। আপনার শংসাপত্র পরীক্ষা করুন বা আবার চেষ্টা করুন।',
                    emailInUse: 'ইমেল ইতিমধ্যে ব্যবহৃত হয়েছে। অনুগ্রহ করে সাইন ইন করুন বা অন্য ইমেল ব্যবহার করুন।',
                    weakPassword: 'পাসওয়ার্ড কমপক্ষে ৬ অক্ষরের হতে হবে।',
                    invalidEmail: 'অবৈধ ইমেল ঠিকানা।',
                    invalidPhoneNumber: 'অনুগ্রহ করে একটি বৈধ ফোন নম্বর লিখুন (যেমন: +8801XXXXXXXXX)।',
                    otpSent: 'আপনার ফোনে ওটিপি পাঠানো হয়েছে। নিচে এটি লিখুন।',
                    otpFailed: 'ওটিপি পাঠাতে ব্যর্থ হয়েছে। আবার চেষ্টা করুন।',
                    invalidOtp: 'অবৈধ ওটিপি। আবার চেষ্টা করুন।',
                    tooManyRequests: 'অনেক বেশি অনুরোধ। অনুগ্রহ করে পরে আবার চেষ্টা করুন।'
                }
            }
        };

        // PWA Variables
        let deferredPrompt;
        let isInstalled = false;
        let userData = null; // This will now be populated by Firebase user

        // Recaptcha Verifier for Phone Auth
        let recaptchaVerifier;
        let confirmationResult;

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    // Register service worker with inline code
                    const swCode = `
                        const CACHE_NAME = 'powercalc-pro-bd-v4';
                        const urlsToCache = [
                            '/',
                            '/index.html',
                            'https://i.ibb.co.com/4RwDKSd1/A-removebg-preview.png',
                            'https://upload.wikimedia.org/wikipedia/commons/4/4a/Logo_of_Google_G_Suite.png' // Google logo
                        ];

                        // Install event
                        self.addEventListener('install', event => {
                            event.waitUntil(
                                caches.open(CACHE_NAME)
                                    .then(cache => {
                                        console.log('Cache opened');
                                        return cache.addAll(urlsToCache);
                                    })
                            );
                        });

                        // Fetch event
                        self.addEventListener('fetch', event => {
                            event.respondWith(
                                caches.match(event.request)
                                    .then(response => {
                                        // Return cached version or fetch from network
                                        return response || fetch(event.request);
                                    }
                                )
                            );
                        });

                        // Activate event
                        self.addEventListener('activate', event => {
                            event.waitUntil(
                                caches.keys().then(cacheNames => {
                                    return Promise.all(
                                        cacheNames.map(cacheName => {
                                            if (cacheName !== CACHE_NAME) {
                                                return caches.delete(cacheName);
                                            }
                                        })
                                    );
                                })
                            );
                        });
                    `;

                    const blob = new Blob([swCode], { type: 'application/javascript' });
                    const swUrl = URL.createObjectURL(blob);
                    
                    const registration = await navigator.serviceWorker.register(swUrl);
                    console.log('ServiceWorker registration successful:', registration);
                } catch (error) {
                    console.log('ServiceWorker registration failed:', error);
                }
            });
        }

        // Language Toggle Functionality
        document.addEventListener('DOMContentLoaded', () => {
            initializeLanguage();
            setCurrentMonthAndYear();
            setupLanguageToggle();
            setupAuthListeners();
            setupRecaptcha();
        });

        function setupLanguageToggle() {
            const langButtons = document.querySelectorAll('.lang-btn');
            langButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const lang = btn.dataset.lang;
                    switchLanguage(lang);
                });
            });
        }

        function initializeLanguage() {
            switchLanguage(currentLanguage);
        }

        function switchLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('powerCalcLanguage', lang);
            
            // Update active button
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.lang === lang);
            });

            // Update all translatable elements
            document.querySelectorAll('[data-en]').forEach(element => {
                const text = element.dataset[lang];
                if (text) {
                    if (element.innerHTML.includes('<br>')) {
                        element.innerHTML = text;
                    } else {
                        element.textContent = text;
                    }
                }
            });

            // Update placeholders
            document.querySelectorAll(`[data-${lang}-placeholder]`).forEach(element => {
                element.placeholder = element.dataset[`${lang}Placeholder`];
            });

            // Update month options
            updateMonthOptions();

            // Update body class for Bengali font
            if (lang === 'bn') {
                document.body.classList.add('bengali');
            } else {
                document.body.classList.remove('bengali');
            }

            // Update welcome message if user exists
            if (userData) {
                updateWelcomeMessage();
            }
        }

        function updateMonthOptions() {
            const monthSelect = document.getElementById('billMonth');
            const options = monthSelect.querySelectorAll('option');
            
            options.forEach((option, index) => {
                if (index === 0) return; // Skip the first "Choose month" option
                
                const monthIndex = index - 1;
                if (currentLanguage === 'bn') {
                    option.textContent = translations.bn.months[monthIndex];
                } else {
                    option.textContent = translations.en.months[monthIndex];
                }
            });
        }

        function setCurrentMonthAndYear() {
            const monthSelect = document.getElementById('billMonth');
            const yearSelect = document.getElementById('billYear');
            const currentDate = new Date();
            const currentMonth = currentDate.toLocaleString('default', { month: 'long' });
            const currentYear = currentDate.getFullYear();

            // Set current month
            monthSelect.value = currentMonth;

            // Populate years (current year and previous 5 years, next 2 years)
            for (let year = currentYear - 5; year <= currentYear + 2; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) {
                    option.selected = true;
                }
                yearSelect.appendChild(option);
            }
        }

        // Firebase Authentication State Listener
        onAuthStateChanged(auth, async (user) => {
            const loadingScreen = document.getElementById('loadingScreen');
            const authScreen = document.getElementById('authScreen');
            const mainContainer = document.getElementById('mainContainer');

            // Simulate loading time
            await new Promise(resolve => setTimeout(resolve, 1500));

            if (user) {
                // User is signed in
                console.log("User signed in:", user);
                userData = {
                    uid: user.uid,
                    name: user.displayName || localStorage.getItem('powerCalcUserName') || user.email || 'User',
                    email: user.email,
                    photoURL: user.photoURL,
                    registrationDate: new Date().toISOString()
                };
                localStorage.setItem('powerCalcUserData', JSON.stringify(userData));
                localStorage.setItem('powerCalcUserName', userData.name); // Store name separately for persistence

                loadingScreen.classList.add('hidden');
                authScreen.classList.remove('show');
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                    authScreen.style.display = 'none';
                    showMainApp();
                }, 500);
            } else {
                // User is signed out
                console.log("User signed out.");
                userData = null;
                localStorage.removeItem('powerCalcUserData');
                localStorage.removeItem('powerCalcUserName');

                loadingScreen.classList.add('hidden');
                mainContainer.classList.remove('show');
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                    mainContainer.style.display = 'none';
                    authScreen.classList.add('show');
                    document.getElementById('nameRegistrationForm').classList.add('hidden'); // Hide name form initially
                    document.getElementById('authError').textContent = ''; // Clear any previous errors
                }, 500);
            }
        });

        function showMainApp() {
            const mainContainer = document.getElementById('mainContainer');
            
            updateWelcomeMessage();

            // Show main container
            mainContainer.classList.add('show');

            // Initialize other components
            displayHistory();
            updateConnectionStatus();
        }

        function updateWelcomeMessage() {
            const welcomeMessage = document.getElementById('welcomeMessage');
            const welcomeText = currentLanguage === 'bn' ? 
                `${translations.bn.welcomeBack}, ${userData.name}!` : 
                `${translations.en.welcomeBack}, ${userData.name}!`;
            welcomeMessage.textContent = welcomeText;
        }

        function showAuthError(message) {
            const authErrorDiv = document.getElementById('authError');
            authErrorDiv.textContent = message;
        }

        function setLoadingState(buttonId, isLoading) {
            const btnText = document.getElementById(`${buttonId}Text`);
            const btnLoading = document.getElementById(`${buttonId}Loading`);
            const btn = document.getElementById(buttonId);

            if (isLoading) {
                btnText.classList.add('hidden');
                btnLoading.classList.remove('hidden');
                btn.disabled = true;
            } else {
                btnText.classList.remove('hidden');
                btnLoading.classList.add('hidden');
                btn.disabled = false;
            }
        }

        function setupAuthListeners() {
            // Google Sign-in
            document.getElementById('googleSignInBtn').addEventListener('click', async () => {
                setLoadingState('googleSignInBtn', true);
                showAuthError('');
                const provider = new GoogleAuthProvider();
                try {
                    const result = await signInWithPopup(auth, provider);
                    // User signed in, onAuthStateChanged will handle the rest
                    console.log("Google sign-in successful:", result.user);
                    // If user has no display name, prompt for name
                    if (!result.user.displayName) {
                        document.getElementById('nameRegistrationForm').classList.remove('hidden');
                        document.getElementById('userName').value = result.user.email.split('@')[0]; // Pre-fill with email part
                    }
                } catch (error) {
                    console.error("Google sign-in error:", error);
                    showAuthError(translations[currentLanguage].errors.authFailed);
                } finally {
                    setLoadingState('googleSignInBtn', false);
                }
            });

            // Email/Password Sign-in
            document.getElementById('signInBtn').addEventListener('click', async (e) => {
                e.preventDefault();
                setLoadingState('signInBtn', true);
                showAuthError('');
                const email = document.getElementById('authEmail').value;
                const password = document.getElementById('authPassword').value;
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    // User signed in, onAuthStateChanged will handle the rest
                } catch (error) {
                    console.error("Email sign-in error:", error);
                    showAuthError(translations[currentLanguage].errors.authFailed);
                } finally {
                    setLoadingState('signInBtn', false);
                }
            });

            // Email/Password Sign-up
            document.getElementById('signUpBtn').addEventListener('click', async (e) => {
                e.preventDefault();
                setLoadingState('signUpBtn', true);
                showAuthError('');
                const email = document.getElementById('authEmail').value;
                const password = document.getElementById('authPassword').value;
                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    console.log("Email sign-up successful:", userCredential.user);
                    // Prompt for name after sign-up
                    document.getElementById('nameRegistrationForm').classList.remove('hidden');
                    document.getElementById('userName').value = email.split('@')[0]; // Pre-fill with email part
                } catch (error) {
                    console.error("Email sign-up error:", error);
                    if (error.code === 'auth/email-already-in-use') {
                        showAuthError(translations[currentLanguage].errors.emailInUse);
                    } else if (error.code === 'auth/weak-password') {
                        showAuthError(translations[currentLanguage].errors.weakPassword);
                    } else if (error.code === 'auth/invalid-email') {
                        showAuthError(translations[currentLanguage].errors.invalidEmail);
                    } else {
                        showAuthError(translations[currentLanguage].errors.authFailed);
                    }
                } finally {
                    setLoadingState('signUpBtn', false);
                }
            });

            // Phone Auth - Send OTP
            document.getElementById('sendOtpBtn').addEventListener('click', async () => {
                setLoadingState('sendOtpBtn', true);
                showAuthError('');
                const phoneNumber = document.getElementById('phoneNumber').value;

                if (!phoneNumber.startsWith('+') || phoneNumber.length < 10) {
                    showAuthError(translations[currentLanguage].errors.invalidPhoneNumber);
                    setLoadingState('sendOtpBtn', false);
                    return;
                }

                try {
                    confirmationResult = await signInWithPhoneNumber(auth, phoneNumber, recaptchaVerifier);
                    document.getElementById('otpInputGroup').classList.remove('hidden');
                    document.getElementById('verifyOtpBtn').classList.remove('hidden');
                    document.getElementById('sendOtpBtn').classList.add('hidden'); // Hide send OTP button
                    showAuthError(translations[currentLanguage].errors.otpSent);
                } catch (error) {
                    console.error("Error sending OTP:", error);
                    if (error.code === 'auth/too-many-requests') {
                        showAuthError(translations[currentLanguage].errors.tooManyRequests);
                    } else {
                        showAuthError(translations[currentLanguage].errors.otpFailed);
                    }
                } finally {
                    setLoadingState('sendOtpBtn', false);
                }
            });

            // Phone Auth - Verify OTP
            document.getElementById('verifyOtpBtn').addEventListener('click', async () => {
                setLoadingState('verifyOtpBtn', true);
                showAuthError('');
                const otpCode = document.getElementById('otpCode').value;

                try {
                    const result = await confirmationResult.confirm(otpCode);
                    console.log("Phone verification successful:", result.user);
                    // User signed in, onAuthStateChanged will handle the rest
                    // If user has no display name, prompt for name
                    if (!result.user.displayName) {
                        document.getElementById('nameRegistrationForm').classList.remove('hidden');
                        document.getElementById('userName').value = result.user.phoneNumber; // Pre-fill with phone number
                    }
                } catch (error) {
                    console.error("Error verifying OTP:", error);
                    showAuthError(translations[currentLanguage].errors.invalidOtp);
                } finally {
                    setLoadingState('verifyOtpBtn', false);
                }
            });

            // Complete Name Registration (for email/phone users or Google users without display name)
            document.getElementById('nameRegistrationForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                setLoadingState('completeRegistrationBtn', true);
                showAuthError('');
                const userNameInput = document.getElementById('userName');
                const name = userNameInput.value.trim();

                if (!name) {
                    showAuthError(translations[currentLanguage].errors.enterName);
                    setLoadingState('completeRegistrationBtn', false);
                    return;
                }

                try {
                    await updateProfile(auth.currentUser, { displayName: name });
                    console.log("User profile updated with name:", name);
                    // Update local storage and proceed to main app
                    userData.name = name;
                    localStorage.setItem('powerCalcUserData', JSON.stringify(userData));
                    localStorage.setItem('powerCalcUserName', name);
                    document.getElementById('authScreen').classList.remove('show');
                    showMainApp();
                } catch (error) {
                    console.error("Error updating profile:", error);
                    showAuthError("Failed to save name. Please try again.");
                } finally {
                    setLoadingState('completeRegistrationBtn', false);
                }
            });

            // Sign Out
            document.getElementById('signOutBtn').addEventListener('click', async () => {
                try {
                    await signOut(auth);
                    // onAuthStateChanged will handle redirecting to auth screen
                } catch (error) {
                    console.error("Error signing out:", error);
                    alert("Failed to sign out. Please try again.");
                }
            });
        }

        function setupRecaptcha() {
            window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', {
                'size': 'normal',
                'callback': (response) => {
                    // reCAPTCHA solved, allow signInWithPhoneNumber.
                    console.log("reCAPTCHA solved!");
                },
                'expired-callback': () => {
                    // Response expired. Ask user to solve reCAPTCHA again.
                    console.log("reCAPTCHA expired.");
                    showAuthError("reCAPTCHA expired. Please try sending OTP again.");
                    document.getElementById('sendOtpBtn').classList.remove('hidden');
                    document.getElementById('otpInputGroup').classList.add('hidden');
                    document.getElementById('verifyOtpBtn').classList.add('hidden');
                }
            });
            recaptchaVerifier.render().then((widgetId) => {
                window.recaptchaWidgetId = widgetId;
            });
        }

        // PWA Install Prompt
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            showInstallBanner();
        });

        function showInstallBanner() {
            const banner = document.getElementById('installBanner');
            banner.classList.add('show');
        }

        document.getElementById('installBtn').addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`User response to the install prompt: ${outcome}`);
                deferredPrompt = null;
                hideInstallBanner();
            }
        });

        document.getElementById('closeBanner').addEventListener('click', () => {
            hideInstallBanner();
        });

        function hideInstallBanner() {
            const banner = document.getElementById('installBanner');
            banner.classList.remove('show');
        }

        // Check if app is installed
        window.addEventListener('appinstalled', () => {
            isInstalled = true;
            hideInstallBanner();
            console.log('PWA was installed');
        });

        // Connection Status
        function updateConnectionStatus() {
            const status = document.getElementById('connectionStatus');
            if (navigator.onLine) {
                const onlineText = currentLanguage === 'bn' ? translations.bn.online : translations.en.online;
                status.innerHTML = `🌐 ${onlineText}`;
                status.className = 'connection-status online';
                setTimeout(() => {
                    status.style.display = 'none';
                }, 2000);
            } else {
                const offlineText = currentLanguage === 'bn' ? translations.bn.offline : translations.en.offline;
                status.innerHTML = `📡 ${offlineText}`;
                status.className = 'connection-status offline';
            }
        }

        window.addEventListener('online', updateConnectionStatus);
        window.addEventListener('offline', updateConnectionStatus);

        // Web App Manifest (inline)
        const manifestData = {
            name: "PowerCalc Pro - Electric Bill Calculator Bangladesh",
            short_name: "PowerCalc Pro BD",
            description: "Professional electric bill calculator with offline functionality for Bangladesh",
            start_url: "/",
            display: "standalone",
            background_color: "#667eea",
            theme_color: "#667eea",
            orientation: "portrait-primary",
            icons: [
                {
                    src: "https://i.ibb.co.com/4RwDKSd1/A-removebg-preview.png",
                    sizes: "192x192",
                    type: "image/png"
                },
                {
                    src: "https://i.ibb.co.com/4RwDKSd1/A-removebg-preview.png",
                    sizes: "512x512",
                    type: "image/png"
                }
            ],
            categories: ["utilities", "productivity"],
            lang: "en-BD"
        };

        const manifestBlob = new Blob([JSON.stringify(manifestData)], { type: 'application/json' });
        const manifestURL = URL.createObjectURL(manifestBlob);
        const manifestLink = document.createElement('link');
        manifestLink.rel = 'manifest';
        manifestLink.href = manifestURL;
        document.head.appendChild(manifestLink);

        // Calculator Logic with History - UPDATED CALCULATION
        let calculationHistory = JSON.parse(localStorage.getItem('powerCalcHistoryBD') || '[]');

        document.getElementById('calculatorForm').addEventListener('submit', function(e) {
            e.preventDefault();
            calculateBill();
        });

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            errorText.textContent = message;
            errorDiv.style.display = 'block';
            errorDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function showLoading(show) {
            const btnText = document.getElementById('btnText');
            const btnLoading = document.getElementById('btnLoading');
            const btn = document.getElementById('calculateBtn');
            
            if (show) {
                btnText.classList.add('hidden');
                btnLoading.classList.remove('hidden');
                btn.disabled = true;
            } else {
                btnText.classList.remove('hidden');
                btnLoading.classList.add('hidden');
                btn.disabled = false;
            }
        }

        function saveToHistory(calculation) {
            calculationHistory.unshift({
                ...calculation,
                date: new Date().toLocaleString(currentLanguage === 'bn' ? 'bn-BD' : 'en-BD'),
                id: Date.now(),
                userName: userData ? userData.name : 'Guest', // Use authenticated user name
                language: currentLanguage
            });
            
            // Keep only last 10 calculations
            if (calculationHistory.length > 10) {
                calculationHistory = calculationHistory.slice(0, 10);
            }
            
            localStorage.setItem('powerCalcHistoryBD', JSON.stringify(calculationHistory));
            displayHistory();
        }

        function displayHistory() {
            const historySection = document.getElementById('historySection');
            const historyList = document.getElementById('historyList');
            
            if (calculationHistory.length === 0) {
                historySection.style.display = 'none';
                return;
            }
            
            historySection.style.display = 'block';
            historyList.innerHTML = '';
            
            calculationHistory.forEach(calc => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                
                const unitsLabel = currentLanguage === 'bn' ? 'ইউনিট' : 'Units';
                const totalLabel = currentLanguage === 'bn' ? 'মোট' : 'Total';
                
                historyItem.innerHTML = `
                    <div class="history-date">${calc.date} • ${calc.userName} • ${calc.month || 'N/A'} ${calc.year || ''}</div>
                    <div class="history-details">
                        <div><strong>${unitsLabel}:</strong> ${calc.usedKwh} KW/h</div>
                        <div><strong>${totalLabel}:</strong> ৳${calc.totalBill}</div>
                    </div>
                `;
                historyList.appendChild(historyItem);
            });
        }

        function calculateBill() {
            // Hide previous errors
            document.getElementById('errorMessage').style.display = 'none';
            
            // Show loading
            showLoading(true);
            
            // Simulate API call delay for better UX
            setTimeout(() => {
                try {
                    // Get input values
                    const billMonth = document.getElementById('billMonth').value;
                    const billYear = document.getElementById('billYear').value;
                    const presentKwh = parseFloat(document.getElementById('presentKwh').value);
                    const pastKwh = parseFloat(document.getElementById('pastKwh').value);

                    // Validate inputs
                    if (!billMonth) {
                        throw new Error(translations[currentLanguage].errors.selectMonth);
                    }
                    
                    if (!billYear) {
                        throw new Error(translations[currentLanguage].errors.selectYear);
                    }
                    
                    if (isNaN(presentKwh) || isNaN(pastKwh)) {
                        throw new Error(translations[currentLanguage].errors.validNumbers);
                    }
                    
                    if (presentKwh < 0 || pastKwh < 0) {
                        throw new Error(translations[currentLanguage].errors.negativeValues);
                    }
                    
                    if (presentKwh < pastKwh) {
                        throw new Error(translations[currentLanguage].errors.currentLessThanPrevious);
                    }

                    // Calculate used KW/h
                    const usedKwh = presentKwh - pastKwh;

                    // Calculate charges based on your provided example - UPDATED RATES
                    const energyCharge = usedKwh * 5.26; // Updated from 6.50 to 5.26
                    const demandCharge = 42; // Updated from 50 to 42
                    const meterFee = 10; // Updated from 15 to 10
                    const subtotal = energyCharge + demandCharge + meterFee;
                    const vatRate = 0.05; // 5% VAT (same as before)
                    const vat = subtotal * vatRate;
                    const totalBill = subtotal + vat;

                    // Display month info
                    const monthText = currentLanguage === 'bn' ? 
                        `${translations.bn.billFor} ${translations.bn.months[translations.en.months.indexOf(billMonth)]} ${billYear}` :
                        `${translations.en.billFor} ${billMonth} ${billYear}`;
                    document.getElementById('monthInfo').textContent = monthText;

                    // Display results with animation
                    document.getElementById('usedKwh').textContent = usedKwh.toFixed(2);
                    document.getElementById('energyCharge').textContent = energyCharge.toFixed(2);
                    document.getElementById('demandCharge').textContent = demandCharge.toFixed(2);
                    document.getElementById('meterFee').textContent = meterFee.toFixed(2);
                    document.getElementById('vat').textContent = vat.toFixed(2);
                    document.getElementById('totalBill').textContent = totalBill.toFixed(2);
                    
                    const resultDiv = document.getElementById('result');
                    resultDiv.style.display = 'block';
                    resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    
                    // Save to history
                    saveToHistory({
                        month: billMonth,
                        year: billYear,
                        presentKwh: presentKwh.toFixed(2),
                        pastKwh: pastKwh.toFixed(2),
                        usedKwh: usedKwh.toFixed(2),
                        energyCharge: energyCharge.toFixed(2),
                        demandCharge: demandCharge.toFixed(2),
                        meterFee: meterFee.toFixed(2),
                        vat: vat.toFixed(2),
                        totalBill: totalBill.toFixed(2)
                    });
                    
                } catch (error) {
                    showError(error.message);
                } finally {
                    showLoading(false);
                }
            }, 800); // Simulate processing time
        }

        // Clear history
        document.getElementById('clearHistory').addEventListener('click', () => {
            const confirmText = currentLanguage === 'bn' ? 
                'আপনি কি নিশ্চিত যে আপনি সমস্ত গণনার ইতিহাস মুছে ফেলতে চান?' :
                'Are you sure you want to clear all calculation history?';
            
            if (confirm(confirmText)) {
                calculationHistory = [];
                localStorage.removeItem('powerCalcHistoryBD');
                displayHistory();
            }
        });

        // Add input validation on blur
        document.getElementById('presentKwh').addEventListener('blur', function() {
            const value = parseFloat(this.value);
            if (value < 0) {
                this.value = '';
                showError(translations[currentLanguage].errors.negativeValues);
            }
        });

        document.getElementById('pastKwh').addEventListener('blur', function() {
            const value = parseFloat(this.value);
            if (value < 0) {
                this.value = '';
                showError(translations[currentLanguage].errors.negativeValues);
            }
        });

        // Add smooth focus transitions
        const inputs = document.querySelectorAll('input, select');
        inputs.forEach(input => {
            input.addEventListener('focus', function() {
                if (this.parentElement.classList.contains('input-wrapper')) {
                    this.parentElement.style.transform = 'scale(1.02)';
                } else {
                    this.style.transform = 'scale(1.02)';
                }
            });
            
            input.addEventListener('blur', function() {
                if (this.parentElement.classList.contains('input-wrapper')) {
                    this.parentElement.style.transform = 'scale(1)';
                } else {
                    this.style.transform = 'scale(1)';
                }
            });
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                const mainContainer = document.getElementById('mainContainer');
                if (mainContainer.classList.contains('show')) {
                    document.getElementById('calculatorForm').dispatchEvent(new Event('submit'));
                }
            }
        });

        // Auto-save form data
        const formInputs = document.querySelectorAll('#calculatorForm input, #calculatorForm select');
        formInputs.forEach(input => {
            // Load saved data
            const savedValue = localStorage.getItem(`form_${input.id}_bd`);
            if (savedValue && input.id !== 'billMonth' && input.id !== 'billYear') { 
                // Don't auto-load month and year, use current values
                input.value = savedValue;
            }
            
            // Save on input
            input.addEventListener('input', () => {
                localStorage.setItem(`form_${input.id}_bd`, input.value);
            });
        });

        console.log('PowerCalc Pro Bangladesh PWA with updated calculation rates loaded successfully! 🚀');
    </script>
</body>
</html>
